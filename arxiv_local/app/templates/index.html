<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArXiv Local - Astro-ph</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script>
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\(', '\)']]
          },
          svg: {
            fontCache: 'global'
          }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <style>
        .paper-card {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        .paper-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2c3e50;
            cursor: pointer;
        }
        .paper-authors {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }
        .paper-abstract {
            font-size: 0.95rem;
            line-height: 1.5;
            text-align: justify;
            margin-top: 10px;
            display: none; /* Hidden by default */
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
        }
        .liked {
            color: #e74c3c !important;
            font-weight: bold;
        }
        .controls {
            position: sticky;
            top: 0;
            background: white;
            z-index: 1000;
            padding: 15px 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .history-item {
            font-size: 0.9rem;
            border-left: 5px solid transparent;
        }
        /* Style for unviewed days: Light Orange background */
        .history-item-unviewed {
            background-color: #fff3cd; /* Bootstrap warning-lightish */
            color: #495057;
            border-left: 5px solid #ffc107;
        }
        /* Style for active (current) day: Blue background */
        .history-item.active {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
        }
        /* Hover effects */
        .history-item-unviewed:hover {
            background-color: #ffe69c;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar: History -->
        <div class="col-md-2 bg-light vh-100 overflow-auto pt-3 border-end">
            <h5 class="mb-3 ps-2">Recent Days</h5>
            <div class="list-group list-group-flush">
                {% for item in history %}
                <a href="/?date={{ item.date }}" 
                   class="list-group-item list-group-item-action history-item 
                          {% if item.is_active %}active{% elif not item.is_viewed %}history-item-unviewed{% endif %}">
                    {{ item.date.strftime('%Y-%m-%d') }}
                    <span class="small opacity-75" style="float:right">{{ item.date.strftime('%a') }}</span>
                    {% if not item.is_viewed and not item.is_active %}
                        <div style="font-size: 0.7em; opacity: 0.8;">(New)</div>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-10">
            <div class="container">
                <div class="controls d-flex justify-content-between align-items-center">
                    <div>
                        <a href="/?date={{ prev_date }}" class="btn btn-outline-secondary btn-sm">&larr; Previous</a>
                        <span class="mx-3 fw-bold fs-5">{{ current_date.strftime('%A, %d %B %Y') }}</span>
                        <a href="/?date={{ next_date }}" class="btn btn-outline-secondary btn-sm">Next &rarr;</a>
                    </div>
                    <div>
                        <form action="/fetch" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-primary btn-sm" title="Fetches approximately last 3-4 weeks of papers">Fetch Recent (2000)</button>
                        </form>
                        <button onclick="trainModel()" class="btn btn-success btn-sm ms-2">Update Recs</button>
                    </div>
                </div>

                <div id="paper-list">
                    {% for paper in papers %}
                    <div class="paper-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="paper-title flex-grow-1" onclick="toggleAbstract('{{ paper.id }}')">
                                {{ paper.title }}
                            </div>
                            <div class="text-nowrap ms-3">
                                <button class="btn btn-link btn-sm p-0 text-decoration-none {% if paper.id in liked_ids %}liked{% else %}text-muted{% endif %}" 
                                        id="like-btn-{{ paper.id }}"
                                        onclick="toggleLike('{{ paper.id }}', event)">
                                    {% if paper.id in liked_ids %}♥ Liked{% else %}♡ Like{% endif %}
                                </button>
                                <span class="badge bg-light text-dark border ms-1">{{"%.2f"|format(paper.score)}}</span>
                            </div>
                        </div>
                        
                        <div class="paper-authors">{{ paper.authors }}</div>
                        
                        <div class="d-flex align-items-center mt-1">
                            <button class="btn btn-outline-primary btn-sm py-0 px-2" style="font-size: 0.7rem;" onclick="toggleAbstract('{{ paper.id }}')">
                                Show Abstract
                            </button>
                            <span class="text-muted ms-2" style="font-size: 0.8rem;">
                                <a href="{{ paper.link }}" target="_blank" class="text-decoration-none text-muted">ArXiv:{{ paper.id }}</a> 
                                <span class="mx-1">|</span>
                                <a href="{{ paper.link.replace('/abs/', '/pdf/') }}.pdf" target="_blank" class="text-decoration-none fw-bold text-danger">PDF</a>
                                <span class="mx-1">|</span>
                                <span class="badge bg-secondary" style="font-size: 0.7em;">{{ paper.arxiv_category }}</span>
                            </span>
                        </div>

                        <div id="abstract-{{ paper.id }}" class="paper-abstract">
                            {{ paper.abstract }}
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if not papers %}
                    <div class="text-center mt-5">
                        <p class="lead">No papers found for this date.</p>
                        <p>Try fetching the latest papers or checking the history sidebar.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function toggleLike(paperId, event) {
        event.stopPropagation(); // Prevent toggling abstract when clicking like
        const btn = document.getElementById(`like-btn-${paperId}`);
        const response = await fetch(`/like/${paperId}`, { method: 'POST' });
        const data = await response.json();
        
        if (data.is_liked) {
            btn.innerHTML = "♥ Liked";
            btn.classList.add("liked");
            btn.classList.remove("text-muted");
        } else {
            btn.innerHTML = "♡ Like";
            btn.classList.remove("liked");
            btn.classList.add("text-muted");
        }
    }

    function toggleAbstract(paperId) {
        const abs = document.getElementById(`abstract-${paperId}`);
        if (abs.style.display === "block") {
            abs.style.display = "none";
        } else {
            abs.style.display = "block";
        }
    }

    async function trainModel() {
        if(confirm("This re-calculates similarity scores based on your likes. It may take a moment. Continue?")) {
            await fetch('/train', { method: 'POST' });
            alert("Training started in background. Refresh page in a few seconds to see updated scores.");
        }
    }
</script>

</body>
</html>
